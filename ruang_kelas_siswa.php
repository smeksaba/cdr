<?php
/**
 * File: ruang_kelas_siswa.php
  * VERSI FINAL: Materi yang sudah dibaca tetap bisa diakses (tidak dikunci).
   */

   require_once 'config/koneksi.php';

   // Proteksi halaman: Pastikan siswa sudah login
   if (!isset($_SESSION['user_id']) || $_SESSION['peran'] != 'siswa') {
       header("Location: login.php");
           exit();
           }
           $id_siswa = $_SESSION['user_id'];

           // Validasi ID Kelas dari URL
           if (!isset($_GET['id_kelas'])) {
               header("Location: siswa_dashboard.php");
                   exit();
                   }
                   $id_kelas = intval($_GET['id_kelas']);

                   // Verifikasi: Pastikan siswa ini terdaftar di kelas yang diakses
                   $stmt_verifikasi = $koneksi->prepare("SELECT COUNT(*) FROM pendaftaran_kelas WHERE id_kelas = ? AND id_siswa = ?");
                   $stmt_verifikasi->bind_param("ii", $id_kelas, $id_siswa);
                   $stmt_verifikasi->execute();
                   $stmt_verifikasi->bind_result($jumlah);
                   $stmt_verifikasi->fetch();
                   $stmt_verifikasi->close();

                   if ($jumlah == 0) {
                       header("Location: siswa_dashboard.php?error=not_enrolled");
                           exit();
                           }

                           // Ambil data kelas untuk ditampilkan
                           $stmt_kelas = $koneksi->prepare("SELECT nama_kelas, deskripsi, mata_pelajaran FROM kelas WHERE id = ?");
                           $stmt_kelas->bind_param("i", $id_kelas);
                           $stmt_kelas->execute();
                           $result_kelas = $stmt_kelas->get_result();
                           $kelas = $result_kelas->fetch_assoc();
                           $stmt_kelas->close();

                           // Query gabungan untuk mendapatkan semua item alur belajar (materi & kuis)
                           $query_alur = "
                               (SELECT
                                       'materi' as tipe, id, judul, konten, tipe_materi, waktu_buka, urutan, tanggal_dibuat
                                           FROM materi WHERE id_kelas = ?)
                                               UNION ALL
                                                   (SELECT
                                                           'kuis' as tipe, id, judul_soal as judul, deskripsi as konten, 'kuis' as tipe_materi, waktu_buka, urutan, waktu_dibuat as tanggal_dibuat
                                                               FROM soal WHERE id_kelas = ?)
                                                                   ORDER BY urutan ASC, tanggal_dibuat ASC
                                                                   ";
                                                                   $stmt_alur = $koneksi->prepare($query_alur);
                                                                   $stmt_alur->bind_param("ii", $id_kelas, $id_kelas);
                                                                   $stmt_alur->execute();
                                                                   $result_alur = $stmt_alur->get_result();
                                                                   $alur_belajar = $result_alur->fetch_all(MYSQLI_ASSOC);
                                                                   $stmt_alur->close();

                                                                   // Siapkan statement untuk mengecek status penyelesaian
                                                                   $stmt_cek_baca = $koneksi->prepare("SELECT id FROM status_baca_materi WHERE id_materi = ? AND id_siswa = ?");
                                                                   $stmt_cek_submit_kuis = $koneksi->prepare("SELECT id FROM jawaban_siswa WHERE id_soal = ? AND id_siswa = ? LIMIT 1");


                                                                   include_once 'templates/header_siswa.php';
                                                                   ?>

                                                                   <nav aria-label="breadcrumb">
                                                                     <ol class="breadcrumb">
                                                                         <li class="breadcrumb-item"><a href="siswa_dashboard.php">Kelas Saya</a></li>
                                                                             <li class="breadcrumb-item active" aria-current="page"><?php echo htmlspecialchars($kelas['nama_kelas']); ?></li>
                                                                               </ol>
                                                                               </nav>

                                                                               <h1 class="mb-2"><?php echo htmlspecialchars($kelas['nama_kelas']); ?></h1>
                                                                               <h5 class="text-muted fw-normal mb-3"><?php echo htmlspecialchars($kelas['mata_pelajaran']); ?></h5>
                                                                               <p class="lead"><?php echo htmlspecialchars($kelas['deskripsi']); ?></p>

                                                                               <?php if(isset($_GET['status']) && $_GET['status'] == 'sukses_submit'): ?>
                                                                               <div class="alert alert-success alert-dismissible fade show" role="alert">
                                                                                 Jawaban Anda telah berhasil dikumpulkan! Materi selanjutnya telah terbuka.
                                                                                   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                                                                   </div>
                                                                                   <?php endif; ?>

                                                                                   <hr>

                                                                                   <h3><i class="bi bi-signpost-split-fill me-2"></i>Alur Belajar</h3>
                                                                                   <p>Selesaikan setiap materi dan tugas secara berurutan untuk melanjutkan.</p>

                                                                                   <div class="list-group">
                                                                                       <?php
                                                                                           $sebelumnya_selesai = true; // Item pertama selalu bisa diakses (jika tidak terjadwal)

                                                                                               if (count($alur_belajar) > 0) {
                                                                                                       foreach ($alur_belajar as $item) {
                                                                                                                   $status_saat_ini_selesai = false;

                                                                                                                               // Cek status penyelesaian item ini
                                                                                                                                           if ($item['tipe'] == 'materi') {
                                                                                                                                                           $stmt_cek_baca->bind_param("ii", $item['id'], $id_siswa);
                                                                                                                                                                           $stmt_cek_baca->execute();
                                                                                                                                                                                           if ($stmt_cek_baca->get_result()->num_rows > 0) {
                                                                                                                                                                                                               $status_saat_ini_selesai = true;
                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                           } elseif ($item['tipe'] == 'kuis') {
                                                                                                                                                                                                                                                           $stmt_cek_submit_kuis->bind_param("ii", $item['id'], $id_siswa);
                                                                                                                                                                                                                                                                           $stmt_cek_submit_kuis->execute();
                                                                                                                                                                                                                                                                                           if ($stmt_cek_submit_kuis->get_result()->num_rows > 0) {
                                                                                                                                                                                                                                                                                                               $status_saat_ini_selesai = true;
                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                           }

                                                                                                                                                                                                                                                                                                                                                       // Tentukan status item: terkunci, terjadwal, atau tersedia
                                                                                                                                                                                                                                                                                                                                                                   $is_terkunci = !$sebelumnya_selesai;
                                                                                                                                                                                                                                                                                                                                                                               $waktu_buka = !empty($item['waktu_buka']) ? new DateTime($item['waktu_buka']) : null;
                                                                                                                                                                                                                                                                                                                                                                                           $is_terjadwal = $waktu_buka && (new DateTime() < $waktu_buka);

                                                                                                                                                                                                                                                                                                                                                                                                       $item_class = '';
                                                                                                                                                                                                                                                                                                                                                                                                                   $item_content = '';
                                                                                                                                                                                                                                                                                                                                                                                                                               $item_icon = $item['tipe'] == 'materi' ? "<i class='bi bi-book-fill text-primary me-3'></i>" : "<i class='bi bi-patch-question-fill text-success me-3'></i>";

                                                                                                                                                                                                                                                                                                                                                                                                                                           if ($is_terkunci) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                           $item_class = 'disabled list-group-item-light';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           $item_content = "<div>" . $item_icon . htmlspecialchars($item['judul']) . "</div> <span class='badge bg-secondary'><i class='bi bi-lock-fill'></i> Terkunci</span>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       } elseif ($is_terjadwal) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       $item_class = 'disabled list-group-item-light';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       $item_content = "<div>" . $item_icon . htmlspecialchars($item['judul']) . "</div> <span class='badge bg-info text-dark'><i class='bi bi-clock-fill'></i> Buka " . $waktu_buka->format('d M Y, H:i') . "</span>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   } else { // Tersedia
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if ($item['tipe'] == 'kuis') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if ($status_saat_ini_selesai) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               // Kuis yang sudah selesai akan dikunci
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       $item_class = 'disabled list-group-item-light';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               $item_content = "<div>" . $item_icon . htmlspecialchars($item['judul']) . "</div> <span class='badge bg-success'><i class='bi bi-check-circle-fill'></i> Soal sudah dikerjakan</span>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           // Kuis yang belum selesai bisa diakses
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   $item_class = 'list-group-item-action';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           $item_content = "<a href='kerjakan_kuis.php?id_kuis={$item['id']}' class='list-group-item {$item_class} d-flex justify-content-between align-items-center'>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div>" . $item_icon . htmlspecialchars($item['judul']) . "</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </a>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 } elseif ($item['tipe'] == 'materi') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     // ======================= PERUBAHAN LOGIKA DI SINI =======================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // Materi, baik sudah dibaca maupun belum, akan selalu bisa diakses (tidak dikunci)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             $tanda_selesai = $status_saat_ini_selesai ? "<span class='badge bg-success'><i class='bi bi-check-circle-fill'></i> Sudah dibaca</span>" : "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $item_class = 'list-group-item-action';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     $item_content = "<a href='#' class='list-group-item {$item_class} d-flex justify-content-between align-items-center'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          data-bs-toggle='modal' data-bs-target='#reviewMateriModal'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               data-id-materi='" . $item['id'] . "'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    data-judul='" . htmlspecialchars($item['judul']) . "'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         data-konten='" . htmlspecialchars($item['konten'], ENT_QUOTES, 'UTF-8') . "'>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div>" . $item_icon . htmlspecialchars($item['judul']) . "</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {$tanda_selesai}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </a>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // ======================= AKHIR DARI PERUBAHAN LOGIKA =======================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Render elemen
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if(strpos($item_content, "<a href") === false) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              echo "<div class='list-group-item {$item_class} d-flex justify-content-between align-items-center'>{$item_content}</div>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo $item_content;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // Update flag untuk item berikutnya
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if ($is_terkunci || $is_terjadwal) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              $sebelumnya_selesai = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          $sebelumnya_selesai = $status_saat_ini_selesai;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo "<div class='list-group-item text-center'>Belum ada materi atau kuis yang ditambahkan oleh guru.</div>";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  $stmt_cek_baca->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      $stmt_cek_submit_kuis->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div class="modal fade" id="reviewMateriModal" tabindex="-1" aria-hidden="true">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="modal-content">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div class="modal-header"><h5 class="modal-title" id="reviewMateriModalLabel"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div class="modal-body" id="reviewMateriContent"></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const reviewMateriModal = document.getElementById('reviewMateriModal');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (reviewMateriModal) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            reviewMateriModal.addEventListener('show.bs.modal', function (event) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const button = event.relatedTarget;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const idMateri = button.getAttribute('data-id-materi');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const judul = button.getAttribute('data-judul');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const konten = button.getAttribute('data-konten');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const modalTitle = reviewMateriModal.querySelector('.modal-title');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const modalBody = reviewMateriModal.querySelector('.modal-body');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    modalTitle.textContent = judul;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            modalBody.innerHTML = konten; // Konten sudah di-escape di PHP, aman untuk dirender

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Cek apakah elemen sudah punya tanda selesai
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const sudahDibaca = button.querySelector('.badge.bg-success');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Hanya tandai dibaca dan refresh jika belum pernah dibaca
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!sudahDibaca) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const formData = new FormData();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    formData.append('id_materi', idMateri);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fetch('tandai_dibaca.php', { method: 'POST', body: formData })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .then(response => response.json())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .then(data => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (data.status === 'success') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Refresh halaman setelah modal ditutup untuk update status alur belajar
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                reviewMateriModal.addEventListener('hidden.bs.modal', function () {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        location.reload();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }, { once: true });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        })
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .catch(error => console.error('Error:', error));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </script>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                $koneksi->close();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                include_once 'templates/footer.php';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ?>